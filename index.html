<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>MindfulTime - åƒ¹å€¼è¿½è¹¤å™¨</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#FFF9F5">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3233/3233483.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3233/3233483.png">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              cream: '#FFF9F5', 'cream-dark': '#F5EBE0',
              text: { main: '#5D5F71', light: '#8E91A0' },
              brand: { 50: '#F2FCF5', 100: '#E1F7E7', 500: '#88D4AB', 600: '#6FC295', 900: '#2D5B45' },
            },
            fontFamily: { sans: ['Quicksand', 'sans-serif'] }
          }
        }
      }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body { font-family: 'Quicksand', 'Noto Sans TC', sans-serif; background-color: #FFF9F5; color: #5D5F71; overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
      ::-webkit-scrollbar { display: none; }
      .btn-card:active { transform: scale(0.96); transition: transform 0.1s; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { createRoot } = ReactDOM;
        const { PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend } = Recharts;

        // ğŸ”¥ å…§å»ºåœ–ç¤ºå…ƒä»¶ (SVG)ï¼Œè§£æ±ºå¤–éƒ¨åº«è¼‰å…¥å¤±æ•—çš„å•é¡Œ
        const Icons = {
            Briefcase: () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Brain: () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            Monitor: () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>,
            Dumbbell: () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></svg>,
            Smartphone: () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></svg>,
            ShoppingBag: () => <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>,
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            LayoutDashboard: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>,
            BarChart2: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            RefreshCcw: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
        };

        // ä½ çš„å¾Œç«¯ç¶²å€
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyyP_FqWOFoJcnnZBit3xc_KR3YRpatQfgOgubnngq83TFJoWuZ3Z6VKvlOUFsUX-0CwA/exec"; 
        
        const CATEGORIES = [
          { id: 'çŸ¥è­˜', label: 'çŸ¥è­˜å­¸ç¿’', icon: <Icons.Briefcase />, color: 'bg-blue-100 text-blue-600', chartColor: '#3B82F6' },
          { id: 'AI', label: 'AI ç ”ç©¶', icon: <Icons.Brain />, color: 'bg-indigo-100 text-indigo-600', chartColor: '#6366F1' },
          { id: 'å¨›æ¨‚', label: 'ä¼‘é–’å¨›æ¨‚', icon: <Icons.Monitor />, color: 'bg-purple-100 text-purple-600', chartColor: '#8B5CF6' },
          { id: 'é‹å‹•', label: 'é‹å‹•å¥èº«', icon: <Icons.Dumbbell />, color: 'bg-emerald-100 text-emerald-600', chartColor: '#10B981' },
          { id: 'ç¤¾ç¾¤', label: 'ç¤¾ç¾¤åª’é«”', icon: <Icons.Smartphone />, color: 'bg-pink-100 text-pink-600', chartColor: '#EC4899' },
          { id: 'è³¼ç‰©', label: 'è³¼ç‰©æ¶ˆè²»', icon: <Icons.ShoppingBag />, color: 'bg-rose-100 text-rose-600', chartColor: '#F43F5E' },
        ];

        function App() {
          const [view, setView] = useState('tracker');
          const [loading, setLoading] = useState(false);
          const [data, setData] = useState({ sessions: [] });
          const [activeTimer, setActiveTimer] = useState(null);
          const [toast, setToast] = useState(null);

          useEffect(() => {
             fetchData();
          }, []);

          const showToast = (msg, type='success') => {
            setToast({msg, type});
            setTimeout(() => setToast(null), 3000);
          };

          const fetchData = () => {
            setLoading(true);
            const fetchUrl = GAS_URL + (GAS_URL.includes('?') ? '&mode=json' : '?mode=json') + `&t=${new Date().getTime()}`;
            
            fetch(fetchUrl)
             .then(res => res.json())
             .then(json => {
                processData(json);
                setLoading(false);
             })
             .catch(err => {
                console.error(err);
                showToast("é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²å€", 'error');
                setLoading(false);
             });
          };

          const processData = (rows) => {
            if (!rows || rows.length === 0) return;
            const validRows = rows.filter(r => r && r.length > 0);
            const newSessions = validRows.map((row, index) => {
                const name = row[1];
                const duration = parseFloat(row[6]) || 0;
                let categoryId = 'çŸ¥è­˜'; 
                const foundCat = CATEGORIES.find(c => c.label === name || c.id === name);
                if (foundCat) categoryId = foundCat.id;

                return {
                    id: index,
                    date: row[0],
                    category: categoryId,
                    duration: duration, 
                    startTimeStr: row[3],
                    appName: name,
                    status: row[2]
                };
            }).reverse();
            setData({ sessions: newSessions });
          };

          const toggleTimer = (category) => {
            if (activeTimer && activeTimer !== category.id) {
              showToast("è«‹å…ˆåœæ­¢ç•¶å‰æ´»å‹•", 'error');
              return;
            }
            const isStarting = !activeTimer;
            setActiveTimer(isStarting ? category.id : null);
            const status = isStarting ? "Open" : "Close";
            
            showToast(isStarting ? `é–‹å§‹ï¼š${category.label}` : `çµæŸï¼š${category.label}`, 'info');

            fetch(GAS_URL, {
              method: 'POST',
              body: JSON.stringify({ appName: category.label, status: status })
            }).then(() => {
               if (!isStarting) fetchData();
            });
          };

          const NavButton = ({ active, onClick, icon: Icon, label }) => (
            <button onClick={onClick} className={`flex flex-col items-center p-2 rounded-2xl transition-all ${active ? 'text-brand-900 bg-brand-100 scale-105' : 'text-text-light hover:text-text-main'}`}>
                <Icon className="w-6 h-6 mb-1" />
                <span className="text-[10px] font-bold">{label}</span>
            </button>
          );

          const chartData = useMemo(() => {
             const stats = {};
             data.sessions.forEach(s => {
                 const cat = CATEGORIES.find(c => c.id === s.category);
                 const label = cat ? cat.label : s.appName;
                 stats[label] = (stats[label] || 0) + s.duration;
             });
             return Object.entries(stats).map(([name, val]) => ({ name, value: Math.round(val/60) }));
          }, [data.sessions]);

          return (
            <div className="flex flex-col h-screen max-w-md mx-auto bg-cream relative">
              <div className="flex justify-between items-center p-6 pb-2">
                 <div className="flex items-center gap-2 text-brand-900">
                    <Icons.Brain />
                    <span className="text-2xl font-bold tracking-tight">MindfulTime</span>
                 </div>
                 <button onClick={fetchData} className={`p-2 bg-white rounded-full shadow-cute border border-brand-100 text-brand-600 ${loading ? 'animate-spin' : ''}`}>
                   <Icons.RefreshCcw />
                 </button>
              </div>

              <div className="flex-1 overflow-y-auto p-6 pb-24 space-y-6">
                
                {view === 'tracker' && (
                  <>
                    <div className="grid grid-cols-2 gap-4">
                      {CATEGORIES.map(cat => {
                        const isActive = activeTimer === cat.id;
                        return (
                          <button key={cat.id} onClick={() => toggleTimer(cat)}
                            className={`btn-card relative p-4 rounded-3xl flex flex-col items-center gap-3 transition-all border-2 
                              ${isActive ? 'bg-brand-600 text-white border-brand-900 shadow-inner' : 'bg-white border-brand-50 shadow-cute hover:shadow-cute-hover'}
                              ${activeTimer && !isActive ? 'opacity-40 grayscale' : ''}
                            `}>
                            <div className={`p-3 rounded-2xl ${isActive ? 'bg-white/20' : cat.color}`}>{cat.icon}</div>
                            <span className="font-bold text-lg">{cat.label}</span>
                            {isActive && <span className="absolute top-3 right-3 animate-ping w-2 h-2 bg-white rounded-full"></span>}
                          </button>
                        )
                      })}
                    </div>

                    <div>
                      <h3 className="text-lg font-bold text-text-main mb-4 flex items-center gap-2">
                        <Icons.Clock /> è¿‘æœŸç´€éŒ„
                      </h3>
                      <div className="space-y-3">
                        {data.sessions.slice(0, 10).map((s, i) => (
                           <div key={i} className="bg-white p-4 rounded-2xl shadow-sm border border-brand-50 flex justify-between items-center">
                              <span className="font-bold text-text-main">{s.appName}</span>
                              <div className="text-right">
                                 <div className="text-xs text-text-light">{s.date}</div>
                                 <div className="font-mono text-brand-600 font-bold">
                                    {s.duration > 0 ? `${(s.duration/60).toFixed(1)} åˆ†` : (s.status === 'Open' ? 'é€²è¡Œä¸­...' : 'å°šæœªçµæŸ')}
                                 </div>
                              </div>
                           </div>
                        ))}
                      </div>
                    </div>
                  </>
                )}

                {view === 'analysis' && (
                   <div className="bg-white p-6 rounded-3xl shadow-cute border border-brand-50 h-80 flex flex-col">
                      <h3 className="font-bold text-text-main mb-4">å°ˆæ³¨åˆ†ä½ˆ</h3>
                      <ResponsiveContainer width="100%" height="100%">
                        <PieChart>
                          <Pie data={chartData} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">
                            {chartData.map((entry, index) => {
                               const def = CATEGORIES.find(c => c.label === entry.name);
                               return <Cell key={index} fill={def ? def.chartColor : '#94A3B8'} />
                            })}
                          </Pie>
                          <Tooltip />
                          <Legend />
                        </PieChart>
                      </ResponsiveContainer>
                   </div>
                )}
              </div>

              <nav className="fixed bottom-0 w-full max-w-md bg-white border-t border-brand-50 flex justify-around items-center p-3 pb-safe z-40 rounded-t-3xl shadow-[0_-4px_20px_-5px_rgba(0,0,0,0.05)]">
                <NavButton active={view === 'tracker'} onClick={() => setView('tracker')} icon={Icons.LayoutDashboard} label="è¿½è¹¤" />
                <NavButton active={view === 'analysis'} onClick={() => setView('analysis')} icon={Icons.BarChart2} label="åˆ†æ" />
                <NavButton active={view === 'settings'} onClick={() => setView('settings')} icon={Icons.Settings} label="è¨­å®š" />
              </nav>

              {toast && (
                <div className="fixed top-6 left-1/2 transform -translate-x-1/2 px-6 py-3 bg-brand-900 text-white rounded-full shadow-lg z-50 animate-bounce text-sm font-bold">
                   {toast.msg}
                </div>
              )}
            </div>
          );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
