<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>MindfulTime</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FAFAFA">
    
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3233/3233483.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3233/3233483.png">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              cream: 'var(--bg-color)',
              'cream-dark': 'var(--border-color)',
              text: { main: 'var(--text-main)', light: 'var(--text-light)' },
              brand: { 50: '#F2FCF5', 100: '#E1F7E7', 500: '#88D4AB', 600: '#6FC295', 900: '#2D5B45' },
              waste: { 500: '#FFB7B2' }, 
              rest: { 500: '#AECBFA' },
              accent: { yellow: '#FDE68A', purple: '#E9D5FF' }
            },
            fontFamily: { sans: ['Nunito', 'sans-serif'] },
            boxShadow: {
              'cute': '0 4px 14px 0 rgba(0,0,0,0.05)',
              'inner-soft': 'inset 0 2px 4px 0 rgba(0, 0, 0, 0.03)',
            },
            animation: { 'fade-in': 'fadeIn 0.4s ease-out', 'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)' },
            keyframes: { 
                fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                slideUp: { '0%': { opacity: 0, transform: 'translateY(15px)' }, '100%': { opacity: 1, transform: 'translateY(0)' } }
            },
            screens: {
                'xs': '375px',
            }
          }
        }
      }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      :root { --bg-color: #FAFAFA; --border-color: #F3F4F6; --text-main: #1F2937; --text-light: #9CA3AF; }
      .theme-dark { --bg-color: #111827; --border-color: #374151; --text-main: #F9FAFB; --text-light: #6B7280; }
      .theme-paper { --bg-color: #FDFBF7; --border-color: #E5E7EB; --text-main: #4B5563; --text-light: #9CA3AF; }
      
      body { font-family: 'Nunito', sans-serif; background-color: var(--bg-color); color: var(--text-main); transition: background-color 0.3s, color 0.3s; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
      ::-webkit-scrollbar { width: 0px; background: transparent; }
      .bg-card { background-color: white; } .theme-dark .bg-card { background-color: #1F2937; }
      input, textarea, select { font-size: 16px !important; } /* Èò≤Ê≠¢ iOS Ëá™ÂãïÁ∏ÆÊîæ */
      .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- 1. ÂÖßÂª∫ÂúñÁ§∫Â∫´ (SVG) ---
        const SvgBase = ({ children, className, size = 22 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );
        const Icons = {
            Bot: (p) => <SvgBase {...p}><rect x="4" y="10" width="16" height="12" rx="3" ry="3" /><path d="M12 4v6m-5-1a5 5 0 0 1 10 0m-9 5h.01m7.98 0h.01"/><line x1="9" y1="1" x2="9" y2="4"/><line x1="15" y1="1" x2="15" y2="4"/></SvgBase>,
            Clock: (p) => <SvgBase {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></SvgBase>,
            Book: (p) => <SvgBase {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></SvgBase>,
            BarChart2: (p) => <SvgBase {...p}><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></SvgBase>,
            Settings: (p) => <SvgBase {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></SvgBase>,
            StopCircle: (p) => <SvgBase {...p}><circle cx="12" cy="12" r="10"/><rect width="6" height="6" x="9" y="9"/></SvgBase>,
            RefreshCcw: (p) => <SvgBase {...p}><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></SvgBase>,
            Briefcase: (p) => <SvgBase {...p}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></SvgBase>,
            MonitorPlay: (p) => <SvgBase {...p}><rect width="20" height="14" x="2" y="3" rx="2" ry="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/><polygon points="10 8 16 11 10 14 10 8"/></SvgBase>,
            Dumbbell: (p) => <SvgBase {...p}><path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/></SvgBase>,
            Smartphone: (p) => <SvgBase {...p}><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></SvgBase>,
            ShoppingBag: (p) => <SvgBase {...p}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></SvgBase>,
            Coffee: (p) => <SvgBase {...p}><path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="1" y2="4"/><line x1="10" x2="10" y1="1" y2="4"/><line x1="14" x2="14" y1="1" y2="4"/></SvgBase>,
            Plus: (p) => <SvgBase {...p}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></SvgBase>,
            Save: (p) => <SvgBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></SvgBase>,
            Send: (p) => <SvgBase {...p}><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></SvgBase>,
            Calendar: (p) => <SvgBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></SvgBase>,
            CheckSquare: (p) => <SvgBase {...p}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></SvgBase>,
            CheckCircle: (p) => <SvgBase {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></SvgBase>,
            Trash2: (p) => <SvgBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></SvgBase>,
            ChevronLeft: (p) => <SvgBase {...p}><path d="m15 18-6-6 6-6"/></SvgBase>,
            ChevronRight: (p) => <SvgBase {...p}><path d="m9 18 6-6-6-6"/></SvgBase>,
            X: (p) => <SvgBase {...p}><path d="M18 6 6 18"/><path d="m6 6 18 12"/></SvgBase>,
            Sparkles: (p) => <SvgBase {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></SvgBase>,
            Circle: (p) => <SvgBase {...p}><circle cx="12" cy="12" r="10"/></SvgBase>,
            Star: (p) => <SvgBase {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></SvgBase>,
            Moon: (p) => <SvgBase {...p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></SvgBase>,
            AlertTriangle: (p) => <SvgBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></SvgBase>,
            AlertCircle: (p) => <SvgBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></SvgBase>,
            Check: (p) => <SvgBase {...p}><polyline points="20 6 9 17 4 12" /></SvgBase>,
            Clipboard: (p) => <SvgBase {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></SvgBase>,
            Link: (p) => <SvgBase {...p}><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></SvgBase>,
            ExternalLink: (p) => <SvgBase {...p}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></SvgBase>,
            HelpCircle: (p) => <SvgBase {...p}><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" x2="12.01" y1="17" y2="17"/></SvgBase>,
            MoreHorizontal: (p) => <SvgBase {...p}><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></SvgBase>,
            Zap: (p) => <SvgBase {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></SvgBase>,
            Mail: (p) => <SvgBase {...p}><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></SvgBase>,
            Sun: (p) => <SvgBase {...p}><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></SvgBase>,
            Key: (p) => <SvgBase {...p}><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></SvgBase>,
            Lightbulb: (p) => <SvgBase {...p}><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-1 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></SvgBase>
        };

        const IconByName = ({ name, className, size }) => {
            const Component = Icons[name] || Icons.HelpCircle;
            return <Component className={className} size={size} />;
        };

        // --- 2. UI Components ---
        const NavButton = ({ active, onClick, icon, label, mobile }) => {
            if (mobile) {
                return (
                    <button onClick={onClick} className={`flex flex-col items-center justify-center w-full h-full transition-all duration-300 ${active ? 'text-brand-600' : 'text-gray-400 hover:text-gray-600'}`}>
                        <div className={`mb-1 transition-all ${active ? '-translate-y-1' : ''}`}>
                            <IconByName name={icon} className="w-5 h-5" />
                        </div>
                        <span className={`text-[10px] font-bold ${active ? 'opacity-100' : 'opacity-0 hidden'} transition-opacity`}>{label}</span>
                        {active && <div className="w-1 h-1 bg-brand-500 rounded-full mt-1"></div>}
                    </button>
                )
            }
            return (
                <button onClick={onClick} className={`w-full flex items-center gap-3 px-5 py-3 rounded-2xl transition-all duration-200 ${active ? 'bg-brand-50 text-brand-600 font-bold' : 'text-text-light hover:bg-gray-50 hover:text-text-main'}`}>
                    <IconByName name={icon} className={active ? 'text-brand-600' : 'text-text-light'} size={20} />
                    <span className="text-sm font-bold">{label}</span>
                </button>
            );
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/30 backdrop-blur-[2px] animate-fade-in">
                    <div className="bg-card rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden animate-slide-up flex flex-col max-h-[90vh]">
                        <div className="flex justify-between items-center p-4 border-b border-gray-100">
                            <h3 className="text-lg font-bold text-text-main flex items-center gap-2"><IconByName name="Sparkles" className="text-accent-yellow fill-accent-yellow w-5 h-5" />{title}</h3>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-50 text-text-light"><IconByName name="X" className="w-5 h-5" /></button>
                        </div>
                        <div className="p-5 overflow-y-auto bg-card">{children}</div>
                    </div>
                </div>
            );
        };

        // --- 3. Donut Chart ---
        const DonutChart = ({ data }) => {
            const total = data.reduce((acc, cur) => acc + cur.value, 0);
            if (total === 0) return <div className="flex h-40 items-center justify-center text-text-light text-sm font-medium">Â∞öÁÑ°Êï∏Êìö</div>;

            let cumulativePercent = 0;
            const size = 180; const center = size / 2; const radius = 70; const strokeWidth = 12; const circumference = 2 * Math.PI * radius;
            const textRadius = radius; 

            return (
                <div className="relative flex justify-center items-center py-4">
                    <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>
                        <circle cx={center} cy={center} r={radius} fill="none" stroke="var(--border-color)" strokeWidth={strokeWidth} opacity="0.3" />
                        {data.map((item, index) => {
                            const percent = item.value / total;
                            if (percent === 0) return null;
                            const startAngle = (cumulativePercent * 360) - 90;
                            const strokeDasharray = `${percent * circumference} ${circumference}`;
                            const strokeDashoffset = -cumulativePercent * circumference;
                            cumulativePercent += percent;
                            let strokeColor = item.name === 'ÊäïË≥á (È´òÂÉπÂÄº)' ? '#88D4AB' : item.name === 'Ê∂àËÄó (Êµ™Ë≤ª)' ? '#FFB7B2' : '#AECBFA';

                            if (percent >= 0.99) {
                                return <circle key={index} cx={center} cy={center} r={radius} fill="none" stroke={strokeColor} strokeWidth={strokeWidth} />;
                            }
                            return (
                                <circle key={index} cx={center} cy={center} r={radius} fill="none" stroke={strokeColor} strokeWidth={strokeWidth} strokeDasharray={strokeDasharray} strokeDashoffset={strokeDashoffset} transform={`rotate(-90 ${center} ${center})`} className="transition-all duration-1000 ease-out" />
                            );
                        })}
                    </svg>
                    <div className="absolute text-center pointer-events-none">
                        <div className="text-2xl font-bold text-text-main leading-none">{Math.round(total/3600*10)/10}</div>
                        <div className="text-[10px] text-text-light font-bold mt-1">Â∞èÊôÇ</div>
                    </div>
                </div>
            );
        };

        // --- 4. Constants & Logic ---
        const GAS_URL = "https://script.google.com/macros/s/AKfycbxGs0h7M7QTAi4HaYopWzj4KzBvO6_wnfpE-jrSzzqX_hcgMbadAPjHmhrDrE4bl139sg/exec"; 
        const SYNC_STORAGE_KEY = 'tm_sync_id';
        const GAS_URL_KEY = 'tm_gas_url';
        const THEME_STORAGE_KEY = 'tm_theme';
        const GEMINI_KEY_STORAGE = 'tm_gemini_key';
        const GEMINI_MODEL_KEY = 'tm_gemini_model';

        const CATEGORY_FIELDS = {
            ai: [{ key: 'tool', label: 'Â∑•ÂÖ∑', type: 'select', options: ['ChatGPT', 'Claude', 'Midjourney', 'Github Copilot'] }, { key: 'goal', label: 'ÁõÆÊ®ô', type: 'text' }],
            knowledge: [{ key: 'topic', label: '‰∏ªÈ°å', type: 'text' }, { key: 'method', label: 'ÊñπÂºè', type: 'select', options: ['Èñ±ËÆÄ', 'Ë™≤Á®ã', 'ÂØ¶‰Ωú'] }],
            entertainment: [{ key: 'content', label: 'ÂÖßÂÆπ', type: 'text' }, { key: 'type', label: 'È°ûÂûã', type: 'select', options: ['ËøΩÂäá', 'ÈõªÂΩ±', 'ÈÅäÊà≤'] }],
            sports: [{ key: 'activity', label: 'È†ÖÁõÆ', type: 'select', options: ['Ë∑ëÊ≠•', 'ÂÅ•Ë∫´ÈáçË®ì', 'Á±ÉÁêÉ', 'ÁæΩÁêÉ'] }, { key: 'detail', label: 'Á¥ÄÈåÑ', type: 'text' }],
            others: [{ key: 'activity', label: 'ÂÖßÂÆπ', type: 'text' }]
        };

        const CATEGORIES = [
          { id: 'ai', label: 'AI Â∑•ÂÖ∑', icon: 'Bot', color: 'bg-indigo-50 text-indigo-500', defaultType: 'growth' },
          { id: 'knowledge', label: 'Áü•Ë≠òÂ≠∏Áøí', icon: 'Book', color: 'bg-blue-50 text-blue-500', defaultType: 'growth' },
          { id: 'entertainment', label: 'Â®õÊ®ÇÊîæÈ¨Ü', icon: 'MonitorPlay', color: 'bg-purple-50 text-purple-500', defaultType: 'waste' },
          { id: 'sports', label: 'ÈÅãÂãïÂÅ•Â∫∑', icon: 'Dumbbell', color: 'bg-emerald-50 text-emerald-500', defaultType: 'rest' },
          { id: 'others', label: 'ÂÖ∂‰ªñ', icon: 'MoreHorizontal', color: 'bg-gray-50 text-gray-500', defaultType: 'waste' }
        ];

        const VALUE_TYPES = [
            { id: 'growth', label: 'ÊäïË≥á (È´òÂÉπÂÄº)', color: 'bg-brand-500', stroke: '#88D4AB' },
            { id: 'waste', label: 'Ê∂àËÄó (Êµ™Ë≤ª)', color: 'bg-waste-500', stroke: '#FFB7B2' },
            { id: 'rest', label: 'ÈÅãÂãï (ÂÅ•Ë∫´)', color: 'bg-rest-500', stroke: '#AECBFA' }
        ];

        const callGeminiAPI = async (apiKey, prompt, model) => {
            const modelName = model || 'gemini-1.5-flash';
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("AI Error:", error);
                return `ÈÄ£Á∑öÂ§±Êïó (${modelName}): ${error.message}`;
            }
        };

        const generateAIResponse = async (input, contextData, type, apiKey, model) => {
            if (!apiKey) return "Ë´ãÂÖàÂà∞Ë®≠ÂÆöÈ†ÅÈù¢Â°´ÂÖ•‰∏¶ÂÑ≤Â≠ò Gemini API Key ÂñîÔºÅüîë";
            
            let systemPrompt = "";
            
            if (type === 'journal') {
                systemPrompt = `‰Ω†ÊòØ‰∏ÄÂÄãÊ∫´ÊüîÁöÑÂøÉÁêÜË´ÆÂïÜÂ∏´„ÄÇ‰ΩøÁî®ËÄÖÊó•Ë®òÔºö"${input}"„ÄÇË´ãÁµ¶‰∫àÂêåÁêÜÂøÉÂõûÊáâËàáÁ∞°Áü≠Âª∫Ë≠∞ÔºåÈôê80Â≠ó„ÄÇ`;
            } else {
                const todayStr = new Date().toISOString().split('T')[0];
                const journalContent = contextData.journal || "Ôºà‰ΩøÁî®ËÄÖ‰ªäÂ§©ÈÇÑÊ≤íÂØ´Êó•Ë®òÔºâ";
                const taskContent = contextData.tasks && contextData.tasks.length > 0 
                    ? contextData.tasks.map(t => `- ${t.content} (${t.done ? 'Â∑≤ÂÆåÊàê' : 'Êú™ÂÆåÊàê'})`).join('\n') 
                    : "ÔºàÁõÆÂâçÊ≤íÊúâ‰ªªÂãôÔºâ";
                const inspirationContent = (contextData.inspirations || []).slice(0, 5).map(i => i.text).join(", ");
                const todaySessions = (contextData.sessions || []).filter(s => s.date === todayStr);
                const stats = {
                    growth: Math.round(todaySessions.filter(s => s.valueType === 'growth').reduce((a,s)=>a+s.duration,0)/60),
                    rest: Math.round(todaySessions.filter(s => s.valueType === 'rest').reduce((a,s)=>a+s.duration,0)/60),
                    waste: Math.round(todaySessions.filter(s => s.valueType === 'waste').reduce((a,s)=>a+s.duration,0)/60)
                };
                
                systemPrompt = `‰Ω†ÊòØ‰∏Ä‰ΩçÂÖ®ËÉΩÁöÑÁîüÊ¥ªÁÆ°ÂÆ∂„ÄÇË´ãÊ†πÊìö‰ª•‰∏ãË≥áË®äÁ∞°Áü≠ÂõûÁ≠î‰ΩøÁî®ËÄÖÔºåË™ûÊ∞£ËºïÈ¨ÜÂÉèÊúãÂèã„ÄÇ
                „ÄêÁãÄÊÖã„ÄëÊó•Ë®ò: "${journalContent}", ‰ªªÂãô: ${taskContent}, ÈùàÊÑü: ${inspirationContent}, ‰ªäÊó•ÊôÇÈñì(ÂàÜ): ÊàêÈï∑${stats.growth}, ÈÅãÂãï${stats.rest}, Êµ™Ë≤ª${stats.waste}
                „ÄêÂïèÈ°å„Äë"${input}"`;
            }
            return await callGeminiAPI(apiKey, systemPrompt, model);
        };

        // --- 5. App ---
        const App = () => {
            const [syncId, setSyncId] = useState(localStorage.getItem(SYNC_STORAGE_KEY));
            const [data, setData] = useState({ sessions: [], journals: {}, activeTimer: null, settings: {}, inspirations: [] });
            const [view, setView] = useState('tracker');
            const [showReviewModal, setShowReviewModal] = useState(false);
            const [elapsedTime, setElapsedTime] = useState(0);
            const [isSyncing, setIsSyncing] = useState(false);
            const [localScriptUrl, setLocalScriptUrl] = useState(localStorage.getItem(GAS_URL_KEY) || GAS_URL);
            const [theme, setTheme] = useState(localStorage.getItem(THEME_STORAGE_KEY) || 'default');
            const [geminiKey, setGeminiKey] = useState(localStorage.getItem(GEMINI_KEY_STORAGE) || '');
            const [availableModels, setAvailableModels] = useState([]);
            const [selectedModel, setSelectedModel] = useState(localStorage.getItem(GEMINI_MODEL_KEY) || 'gemini-1.5-flash');
            const [reviewRating, setReviewRating] = useState(3);
            const [reviewType, setReviewType] = useState('growth');
            const [reviewNote, setReviewNote] = useState('');
            const [manualMinutes, setManualMinutes] = useState('');
            const [reviewMetaData, setReviewMetaData] = useState({});
            const [reviewSessionCache, setReviewSessionCache] = useState(null);
            const [newInspiration, setNewInspiration] = useState('');
            const [journalSelectedDate, setJournalSelectedDate] = useState(new Date());
            const [calendarViewDate, setCalendarViewDate] = useState(new Date());
            const [journalText, setJournalText] = useState('');
            const [managerMessages, setManagerMessages] = useState([{ id: 'init', role: 'ai', text: 'üëã Âó®ÔºÅÊàëÊòØ‰Ω†ÁöÑ AI ÁîüÊ¥ªÁÆ°ÂÆ∂„ÄÇ‰ªäÂ§©ÊÉ≥ËÅäËÅäË°åÁ®ãË¶èÂäÉÂóéÔºü', timestamp: Date.now() }]);
            const [managerInput, setManagerInput] = useState('');
            const [journalAiResponse, setJournalAiResponse] = useState('');
            const [isAiTyping, setIsAiTyping] = useState(false);
            const [taskContent, setTaskContent] = useState('');
            const [taskValue, setTaskValue] = useState('');
            const [dayTasks, setDayTasks] = useState([]);
            const chatEndRef = useRef(null);
            const [toastMessage, setToastMessage] = useState(null);
            const [analysisDate, setAnalysisDate] = useState(new Date());
            const [analysisViewMode, setAnalysisViewMode] = useState('day');
            const [lastSyncTime, setLastSyncTime] = useState(null);

            useEffect(() => { document.body.className = theme === 'dark' ? 'theme-dark' : theme === 'paper' ? 'theme-paper' : ''; localStorage.setItem(THEME_STORAGE_KEY, theme); }, [theme]);
            useEffect(() => { if (!syncId) { const newId = Math.random().toString(36).substr(2, 9); localStorage.setItem(SYNC_STORAGE_KEY, newId); setSyncId(newId); } }, [syncId]);
            useEffect(() => { 
                const savedData = localStorage.getItem(`tm_data_${syncId}`); 
                if (savedData) {
                    let parsedData = JSON.parse(savedData);
                    if (parsedData.sessions) {
                        parsedData.sessions = parsedData.sessions.map(s => {
                            const catDef = CATEGORIES.find(c => c.id === s.category);
                            if (catDef && s.valueType !== catDef.defaultType) return { ...s, valueType: catDef.defaultType };
                            return s;
                        });
                    }
                    setData(parsedData); 
                }
            }, [syncId]);

            const saveDataToLocal = (newData) => { setData(newData); localStorage.setItem(`tm_data_${syncId}`, JSON.stringify(newData)); }
            const getLocalDateStr = (d) => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            const formatTime = (s) => { const m = Math.floor(s / 60); const sec = s % 60; return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`; };
            const formatDurationSimple = (s) => { const m = Math.round(s/60); return `${m}m`; };

            useEffect(() => { 
                const dateStr = getLocalDateStr(journalSelectedDate); 
                setJournalText(data.journals?.[dateStr]?.content || ''); 
                setDayTasks(data.journals?.[dateStr]?.tasks || []); 
                setJournalAiResponse(''); 
            }, [journalSelectedDate, data.journals]);

            useEffect(() => { let interval; if (data.activeTimer?.isRunning) { interval = setInterval(() => { setElapsedTime(Math.floor((Date.now() - data.activeTimer.startTime) / 1000)); }, 1000); } else { setElapsedTime(0); } return () => clearInterval(interval); }, [data.activeTimer]);
            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [managerMessages, isAiTyping]);
            
            const showToast = (msg, type='success') => { setToastMessage({ text: msg, type }); setTimeout(() => setToastMessage(null), 3000); };
            
            const addTask = () => {
                if (!taskContent.trim()) return;
                const newTask = { id: Date.now(), content: taskContent, value: taskValue, done: false };
                setDayTasks([...dayTasks, newTask]);
                setTaskContent('');
                setTaskValue('');
            };

            const toggleTask = (taskId) => {
                setDayTasks(dayTasks.map(t => t.id === taskId ? { ...t, done: !t.done } : t));
            };

            const startTimer = (catId) => { if (data.activeTimer) return; saveDataToLocal({ ...data, activeTimer: { startTime: Date.now(), category: catId, isRunning: true } }); };
            
            const cancelTimer = () => {
                if (!confirm("Á¢∫ÂÆöË¶ÅÂèñÊ∂àÈÄôÊ¨°Ë®àÊôÇÂóéÔºü")) return;
                saveDataToLocal({ ...data, activeTimer: null });
                setElapsedTime(0);
                showToast("Â∑≤ÂèñÊ∂àË®àÊôÇ", "warning");
            };

            const stopTimer = () => { 
                if (!data.activeTimer) return; 
                const currentDurationSec = Math.floor((Date.now() - data.activeTimer.startTime) / 1000);
                setReviewSessionCache({ startTime: data.activeTimer.startTime, category: data.activeTimer.category }); 
                setManualMinutes(Math.round(currentDurationSec / 60).toString());
                const categoryDef = CATEGORIES.find(c => c.id === data.activeTimer.category); 
                if (categoryDef?.defaultType) setReviewType(categoryDef.defaultType); 
                setReviewMetaData({}); 
                setShowReviewModal(true); 
            };
            
            const submitReview = () => {
                if (!reviewSessionCache) return;
                const endTime = Date.now();
                const startTime = reviewSessionCache.startTime;
                let duration = Math.floor((endTime - startTime) / 1000);
                if (['sports', 'others'].includes(reviewSessionCache.category) && manualMinutes) {
                    duration = parseInt(manualMinutes) * 60;
                }
                const categoryLabel = CATEGORIES.find(c => c.id === reviewSessionCache.category)?.label || 'Êú™ÂàÜÈ°û';
                const newSession = {
                    id: Math.random().toString(36).substr(2, 9),
                    category: reviewSessionCache.category,
                    startTime,
                    endTime,
                    duration,
                    valueType: reviewType,
                    rating: reviewRating,
                    note: reviewNote,
                    meta: reviewMetaData,
                    date: getLocalDateStr(new Date(startTime)),
                    status: 'completed'
                };
                saveDataToLocal({ ...data, sessions: [newSession, ...data.sessions], activeTimer: null });
                setShowReviewModal(false);
                setReviewNote('');
                setReviewMetaData({});
                setManualMinutes(''); 
                showToast("Á¥ÄÈåÑÊàêÂäüÔºÅ‚≠ê");
                if (localScriptUrl) {
                    const payload = { date: newSession.date, appName: categoryLabel, duration: duration, note: reviewNote };
                    fetch(localScriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) }).then(() => console.log("Ë≥áÊñôÂ∑≤ÁôºÈÄÅËá≥Èõ≤Á´Ø")).catch(error => showToast("Èõ≤Á´ØÂêåÊ≠•Â§±Êïó", 'error'));
                }
            };

            const syncFromGoogleSheet = async () => { const url = localScriptUrl; if (!url) return showToast("Ë´ãÂÖàË®≠ÂÆö URL", 'error'); setIsSyncing(true); try { const res = await fetch(url + (url.includes('?') ? '&mode=json' : '?mode=json') + `&t=${Date.now()}`); const json = await res.json(); if(Array.isArray(json)) { const newSessions = json.map(item => { 
                let catId = null;
                const name = (item.appName || '').toLowerCase();
                if(name.includes('Â≠∏Áøí') || name.includes('book') || name.includes('Áü•Ë≠ò')) catId = 'knowledge';
                else if(name.includes('ai') || name.includes('gpt')) catId = 'ai';
                else if(name.includes('ÈÅãÂãï') || name.includes('gym') || name.includes('ÂÅ•Ë∫´')) catId = 'sports';
                else if(name.includes('Â®õÊ®Ç') || name.includes('youtube') || name.includes('netflix')) catId = 'entertainment';
                else if(name.includes('Á§æÁæ§') || name.includes('social') || name.includes('line') || name.includes('instagram')) catId = 'others'; 
                else if(name.includes('Ë≥ºÁâ©') || name.includes('shopping')) catId = 'others';
                if (!catId) return null;
                const dateStr = item.date.replace(/\//g, '-'); 
                return { id: `imp-${dateStr}-${name}-${item.duration}`, category: catId, duration: parseInt(item.duration) || 0, date: dateStr, valueType: CATEGORIES.find(c=>c.id===catId)?.defaultType || 'waste', note: item.appName, status: 'completed' }; 
            }).filter(s => s && s.duration > 0); 
            const uniqueNewSessions = newSessions.filter(newS => { return !data.sessions.some(oldS => oldS.date === newS.date && oldS.note === newS.note && Math.abs(oldS.duration - newS.duration) < 0.01); }); if (uniqueNewSessions.length === 0) showToast("Ê≤íÊúâÊñ∞ÁöÑË≥áÊñôÈúÄÂåØÂÖ•", 'success'); else { saveDataToLocal({ ...data, sessions: [...data.sessions, ...uniqueNewSessions] }); showToast(`ÊàêÂäüÂåØÂÖ• ${uniqueNewSessions.length} Á≠ÜÊñ∞Ë≥áÊñô`, 'success'); } setLastSyncTime(new Date().toLocaleTimeString()); } } catch(e) { showToast("ÈÄ£Á∑öÂ§±Êïó", 'error'); } finally { setIsSyncing(false); } };
            
            const saveKey = () => { localStorage.setItem(GEMINI_KEY_STORAGE, geminiKey); showToast("API Key Â∑≤ÂÑ≤Â≠òÔºÅ"); };
            const detectModels = async () => { if (!geminiKey) return showToast("Ë´ãÂÖàËº∏ÂÖ• API Key", "error"); showToast("ÂÅµÊ∏¨Ê®°Âûã‰∏≠...", "warning"); try { const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${geminiKey}`); const data = await res.json(); if (data.models) { const contentModels = data.models.filter(m => m.supportedGenerationMethods.includes("generateContent")).map(m => m.name.replace('models/', '')); setAvailableModels(contentModels); if (contentModels.length > 0 && !contentModels.includes(selectedModel)) { setSelectedModel(contentModels[0]); } showToast(`ÊâæÂà∞ ${contentModels.length} ÂÄãÂèØÁî®Ê®°Âûã`, "success"); } else { throw new Error(data.error?.message || "ÁÑ°ÂõûÊáâ"); } } catch (e) { showToast("ÂÅµÊ∏¨Â§±Êïó: " + e.message, "error"); } };
            
            const handleManagerChat = async () => { 
                if (!managerInput.trim()) return; 
                const currentInput = managerInput;
                setManagerInput(''); 
                const userMsg = { id: Date.now().toString(), role: 'user', text: currentInput, timestamp: Date.now() }; 
                setManagerMessages(prev => [...prev, userMsg]); 
                setIsAiTyping(true); 
                const liveContext = {
                    journal: journalText, 
                    tasks: dayTasks,      
                    inspirations: data.inspirations || [],
                    sessions: data.sessions
                };
                const responseText = await generateAIResponse(currentInput, liveContext, 'manager', geminiKey, selectedModel); 
                const aiMsg = { id: (Date.now()+1).toString(), role: 'ai', text: responseText, timestamp: Date.now() }; 
                setManagerMessages(prev => [...prev, aiMsg]); 
                setIsAiTyping(false); 
            };
            
            const handleJournalAI = async () => { if (!journalText.trim()) return; setIsAiTyping(true); const responseText = await generateAIResponse(journalText, data, 'journal', geminiKey, selectedModel); setJournalAiResponse(responseText); setIsAiTyping(false); };
            const addInspiration = () => { if(!newInspiration.trim()) return; const newItem = { id: Date.now(), text: newInspiration, date: getLocalDateStr(new Date()) }; const newData = { ...data, inspirations: [newItem, ...(data.inspirations || [])] }; saveDataToLocal(newData); setNewInspiration(''); showToast("ÈùàÊÑüÂ∑≤ÊçïÊçâ ‚ú®"); };

            // Calculations
            const targetSessions = useMemo(() => { if (analysisViewMode === 'total') return data.sessions; const targetDate = getLocalDateStr(analysisDate); return data.sessions.filter(s => s.date === targetDate); }, [data.sessions, analysisDate, analysisViewMode]);
            const chartData = useMemo(() => { const stats = { growth: 0, waste: 0, rest: 0 }; targetSessions.forEach(s => { if(stats[s.valueType] !== undefined) stats[s.valueType] += s.duration; }); const total = Object.values(stats).reduce((a,b) => a+b, 0); return VALUE_TYPES.map(vt => ({ id: vt.id, name: vt.label, value: stats[vt.id] || 0, percent: total > 0 ? ((stats[vt.id] || 0) / total * 100).toFixed(0) : 0, color: vt.stroke })); }, [targetSessions]);
            const dashboardStats = useMemo(() => { const totalDuration = targetSessions.reduce((acc, s) => acc + s.duration, 0); const growthDuration = targetSessions.filter(s => s.valueType === 'growth').reduce((acc, s) => acc + s.duration, 0); const growthPercent = totalDuration > 0 ? Math.round((growthDuration / totalDuration) * 100) : 0; const knowledgeDuration = targetSessions.filter(s => s.category === 'knowledge').reduce((acc, s) => acc + s.duration, 0); return { totalDuration, growthDuration, growthPercent, knowledgeDuration }; }, [targetSessions]);
            const groupedAggregatedSessions = useMemo(() => { const groups = {}; data.sessions.forEach(session => { if (!groups[session.date]) groups[session.date] = {}; if (!groups[session.date][session.category]) groups[session.date][session.category] = { duration: 0, count: 0, meta: [] }; groups[session.date][session.category].duration += session.duration; groups[session.date][session.category].count += 1; if(session.meta && Object.keys(session.meta).length > 0) { const metaStr = Object.values(session.meta).join(', '); if(!groups[session.date][session.category].meta.includes(metaStr)) groups[session.date][session.category].meta.push(metaStr); } }); return Object.entries(groups).sort((a,b) => b[0].localeCompare(a[0])).map(([date, cats]) => ({ date, categories: Object.entries(cats).map(([catId, stats]) => ({ id: catId, ...stats, def: CATEGORIES.find(c => c.id === catId) })) })); }, [data.sessions]);
            
            const renderCalendar = () => { const year = calendarViewDate.getFullYear(); const month = calendarViewDate.getMonth(); const daysInMonth = new Date(year, month + 1, 0).getDate(); const firstDay = new Date(year, month, 1).getDay(); const days = []; for (let i = 0; i < firstDay; i++) days.push(<div key={`pad-${i}`} className="h-8"></div>); for (let d = 1; d <= daysInMonth; d++) { const dateStr = getLocalDateStr(new Date(year, month, d)); const hasEntry = !!data.journals?.[dateStr]?.content; const isSelected = journalSelectedDate.getDate() === d && journalSelectedDate.getMonth() === month; days.push( <button key={d} onClick={() => setJournalSelectedDate(new Date(year, month, d))} className={`h-8 w-8 rounded-full flex flex-col items-center justify-center relative transition-all ${isSelected ? 'bg-brand-500 text-white shadow-md' : 'text-text-main hover:bg-gray-100'}`}> <span className="text-xs font-bold">{d}</span> {hasEntry && !isSelected && <span className="w-1 h-1 bg-brand-500 rounded-full absolute bottom-1"></span>} </button> ); } return days; };
            
            return (
                <div className="flex min-h-screen bg-cream font-sans transition-colors duration-300">
                    {toastMessage && <div className={`fixed top-6 left-1/2 -translate-x-1/2 z-[60] px-6 py-3 rounded-full shadow-lg animate-fade-in border border-white/20 backdrop-blur-md ${toastMessage.type === 'error' ? 'bg-waste-500 text-white' : toastMessage.type === 'warning' ? 'bg-yellow-500 text-white' : 'bg-brand-500 text-white'}`}><div className="font-bold px-2 text-sm">{toastMessage.text}</div></div>}

                    <nav className="hidden md:flex flex-col w-64 h-screen border-r border-cream-dark p-6 bg-card fixed left-0 top-0 z-50 transition-colors duration-300">
                        <div className="flex items-center gap-3 mb-10 px-2"><div className="p-2 bg-brand-50 rounded-xl"><IconByName name="Bot" className="w-6 h-6 text-brand-600"/></div><span className="text-lg font-bold tracking-tight text-text-main">MindfulTime</span></div>
                        <div className="space-y-2">
                            <NavButton active={view === 'tracker'} onClick={() => setView('tracker')} icon="Clock" label="ÊôÇÂÖâËä±Âúí" />
                            <NavButton active={view === 'journal'} onClick={() => setView('journal')} icon="Book" label="ÂøÉÊÉÖÊó•Ë®ò" />
                            <NavButton active={view === 'analysis'} onClick={() => setView('analysis')} icon="BarChart2" label="ÊàêÈï∑Ê¥ûÂØü" />
                            <NavButton active={view === 'muse'} onClick={() => setView('muse')} icon="Lightbulb" label="ÈùàÊÑüÁ¢éÁâá" />
                            <NavButton active={view === 'settings'} onClick={() => setView('settings')} icon="Settings" label="Ë®≠ÂÆö" />
                        </div>
                    </nav>

                    <main className="flex-1 p-4 pb-24 md:p-8 max-w-6xl mx-auto w-full overflow-y-auto md:ml-64 transition-colors duration-300 min-h-screen">
                        {/* Header */}
                        <header className="md:hidden flex justify-between items-center mb-6"><span className="font-bold text-brand-900 flex items-center gap-2 text-lg"><IconByName name="Bot" className="w-6 h-6"/> MindfulTime</span><button onClick={() => setView('settings')}><IconByName name="Settings" className="w-5 h-5 text-text-light"/></button></header>
                        
                        {/* Timer Banner */}
                        {data.activeTimer && <div className="bg-card text-text-main border border-brand-100 rounded-2xl p-5 shadow-sm flex flex-col sm:flex-row items-center justify-between gap-6 mb-6 relative overflow-hidden">
                            <div className="flex items-center gap-4 z-10 w-full sm:w-auto">
                                <div className="p-3 bg-brand-50 rounded-xl"><IconByName name="Clock" className="w-6 h-6 text-brand-500"/></div>
                                <div><div className="text-brand-600 text-[10px] font-bold uppercase mb-1">Ê≠£Âú®Â∞àÊ≥®</div><div className="text-xl font-bold">{CATEGORIES.find(c => c.id === data.activeTimer.category)?.label}</div></div>
                            </div>
                            <div className="font-mono text-4xl font-bold tracking-tight z-10 tabular-nums text-brand-600">{formatTime(elapsedTime)}</div>
                            <div className="flex gap-3 z-10 w-full sm:w-auto">
                                <button onClick={cancelTimer} className="p-3 bg-gray-50 hover:bg-waste-500 hover:text-white text-gray-400 font-bold rounded-xl transition-colors"><IconByName name="Trash2" className="w-5 h-5"/></button>
                                <button onClick={stopTimer} className="flex-1 sm:flex-none px-6 py-3 bg-brand-500 hover:bg-brand-600 text-white font-bold rounded-xl shadow-sm flex items-center justify-center gap-2 transition-colors"><IconByName name="StopCircle" className="w-5 h-5"/> <span>ÂÆåÊàê</span></button>
                            </div>
                        </div>}

                        {view === 'tracker' && (
                            <div className="space-y-6 animate-fade-in pb-20">
                                <div className="grid grid-cols-2 gap-3">
                                    {CATEGORIES.map(cat => (
                                        <button key={cat.id} onClick={() => startTimer(cat.id)} className="relative group bg-white border border-gray-100 rounded-2xl p-4 flex flex-col items-center justify-center gap-3 h-28 hover:border-brand-200 hover:shadow-md transition-all active:scale-95 shadow-sm">
                                            <div className={`p-2 rounded-full ${cat.color.replace('text-', 'bg-').replace('50', '50/50')} ${cat.color}`}><IconByName name={cat.icon} className="w-5 h-5" /></div>
                                            <span className="font-bold text-sm text-text-main">{cat.label}</span>
                                        </button>
                                    ))}
                                </div>
                                <div className="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-lg font-bold text-text-main flex items-center gap-2"><IconByName name="Clock" className="w-5 h-5 text-brand-500" /> ‰ªäÊó•Ë∂≥Ë∑°</h2>
                                        <button onClick={syncFromGoogleSheet} className="text-xs font-bold text-brand-600 bg-brand-50 px-3 py-1.5 rounded-lg hover:bg-brand-100 transition-colors flex items-center gap-1"><IconByName name="RefreshCcw" className={`w-3 h-3 ${isSyncing?'animate-spin':''}`}/> Êõ¥Êñ∞</button>
                                    </div>
                                    {groupedAggregatedSessions.length === 0 ? <div className="text-center py-10 text-gray-400 text-sm font-medium bg-gray-50/50 rounded-xl border border-dashed border-gray-200">‰ªäÂ§©ÈÇÑÊ≤íÈñãÂßãÁ¥ÄÈåÑ üå±</div> : 
                                        <div className="space-y-6 relative pl-2">
                                            <div className="absolute left-4 top-2 bottom-2 w-0.5 bg-gray-100"></div>
                                            {groupedAggregatedSessions.map(group => (
                                                <div key={group.date} className="relative pl-8">
                                                    <div className="absolute left-[5px] top-1.5 w-2.5 h-2.5 rounded-full bg-white border-2 border-brand-400 z-10"></div>
                                                    <h3 className="font-bold text-sm text-gray-400 mb-3">{group.date}</h3>
                                                    <div className="space-y-3">
                                                        {group.categories.map(item => (
                                                            <div key={item.id} className="bg-gray-50/80 rounded-xl p-3 flex items-center justify-between border border-transparent hover:border-gray-200 hover:bg-white transition-all">
                                                                <div className="flex items-center gap-3">
                                                                    <div className="p-2 bg-white rounded-lg shadow-sm text-text-light"><IconByName name={item.def?.icon} className="w-4 h-4" /></div>
                                                                    <div><div className="font-bold text-sm text-text-main">{item.def?.label}</div>{item.meta && item.meta.length > 0 && <div className="text-[10px] text-gray-400 truncate max-w-[150px]">{item.meta.join(', ')}</div>}</div>
                                                                </div>
                                                                <div className="font-mono font-bold text-sm text-brand-600">{formatDurationSimple(item.duration)}</div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    }
                                </div>
                            </div>
                        )}

                        {view === 'journal' && (
                            <div className="flex flex-col lg:flex-row gap-6 animate-slide-up h-full min-h-screen pb-20">
                                <div className="lg:w-1/3 flex flex-col gap-6">
                                    <div className="bg-white rounded-2xl shadow-sm p-5 border border-gray-100">
                                        <div className="flex justify-between items-center mb-4">
                                            <button onClick={() => setJournalSelectedDate(new Date(journalSelectedDate.setMonth(journalSelectedDate.getMonth()-1)))} className="p-2 hover:bg-gray-50 rounded-full transition-colors text-text-light"><IconByName name="ChevronLeft" className="w-4 h-4"/></button>
                                            <span className="font-bold text-lg text-text-main">{journalSelectedDate.getFullYear()}Âπ¥ {journalSelectedDate.getMonth()+1}Êúà</span>
                                            <button onClick={() => setJournalSelectedDate(new Date(journalSelectedDate.setMonth(journalSelectedDate.getMonth()+1)))} className="p-2 hover:bg-gray-50 rounded-full transition-colors text-text-light"><IconByName name="ChevronRight" className="w-4 h-4"/></button>
                                        </div>
                                        <div className="grid grid-cols-7 gap-y-2 justify-items-center font-bold text-gray-400 text-xs mb-2"><span>Êó•</span><span>‰∏Ä</span><span>‰∫å</span><span>‰∏â</span><span>Âõõ</span><span>‰∫î</span><span>ÂÖ≠</span></div>
                                        <div className="grid grid-cols-7 gap-y-2 justify-items-center font-bold text-text-main">{renderCalendar()}</div>
                                    </div>
                                </div>
                                <div className="lg:w-2/3 flex flex-col gap-4">
                                    <div className="flex items-center gap-2"><h2 className="text-xl font-bold text-text-main">{getLocalDateStr(journalSelectedDate)}</h2><span className="px-2 py-0.5 bg-gray-100 text-gray-500 text-[10px] font-bold rounded-md">Êó•Ë®ò</span></div>
                                    <div className="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                                        <div className="flex items-center gap-2 mb-4 text-text-main font-bold text-sm"><IconByName name="CheckSquare" className="w-4 h-4"/> ‰ªäÊó•‰ªªÂãô</div>
                                        <div className="flex gap-2 mb-4">
                                            <input type="text" placeholder="‰ªªÂãôÂÖßÂÆπ..." className="flex-1 p-3 bg-gray-50 text-text-main placeholder-gray-400 rounded-xl font-medium outline-none text-sm focus:bg-white focus:ring-2 focus:ring-brand-100 transition-all" value={taskContent} onChange={e => setTaskContent(e.target.value)}/>
                                            <input type="text" placeholder="ÂÉπÂÄº" className="w-20 p-3 bg-gray-50 text-text-main placeholder-gray-400 rounded-xl font-medium outline-none text-sm focus:bg-white focus:ring-2 focus:ring-brand-100 transition-all text-center" value={taskValue} onChange={e => setTaskValue(e.target.value)} onKeyDown={e => e.key === 'Enter' && addTask()}/>
                                            <button onClick={addTask} className="p-3 bg-brand-500 text-white rounded-xl hover:bg-brand-600 transition-colors shadow-sm"><IconByName name="Plus" className="w-5 h-5"/></button>
                                        </div>
                                        <div className="space-y-2">
                                            {dayTasks.map(task => (
                                                <div key={task.id} onClick={() => toggleTask(task.id)} className="flex items-center gap-3 p-3 bg-gray-50 rounded-xl cursor-pointer hover:bg-white hover:shadow-sm border border-transparent hover:border-gray-100 transition-all group">
                                                    <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center ${task.done ? 'bg-brand-500 border-brand-500' : 'border-gray-300'}`}>{task.done && <IconByName name="Check" className="w-3 h-3 text-white"/>}</div>
                                                    <div className={`flex-1 font-bold text-sm ${task.done ? 'text-gray-400 line-through' : 'text-text-main'}`}>{task.content}</div>
                                                    {task.value && <div className="text-[10px] text-brand-600 bg-brand-50 px-2 py-0.5 rounded-md font-bold">{task.value}</div>}
                                                    <button onClick={(e) => { e.stopPropagation(); setDayTasks(dayTasks.filter(t => t.id !== task.id)); }} className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-waste-500 p-1"><IconByName name="X" className="w-3 h-3"/></button>
                                                </div>
                                            ))}
                                            {dayTasks.length === 0 && <div className="text-center text-xs text-gray-300 font-bold py-2">ÈÇÑÊ≤íÊúâ‰ªªÂãôÔºåÊñ∞Â¢û‰∏ÄÈ†ÖÂêßÔºÅüå±</div>}
                                        </div>
                                    </div>
                                    <div className="flex-1 bg-white rounded-2xl shadow-sm p-5 relative min-h-[200px] flex flex-col border border-gray-100">
                                        <textarea className="w-full h-full bg-transparent text-text-main placeholder-gray-300 text-base leading-relaxed outline-none resize-none font-medium" placeholder="‰ªäÂ§©ÈÅéÂæóÊÄéÈ∫ºÊ®£ÔºüÂØ´‰∏ã‰æÜÂêß..." value={journalText} onChange={e => setJournalText(e.target.value)}/>
                                        {journalAiResponse && <div className="mt-4 bg-brand-50 p-4 rounded-xl border border-brand-100"><div className="flex items-center gap-2 text-brand-600 font-bold mb-1 text-xs"><IconByName name="Bot" className="w-3 h-3"/> AI ÂàÜÊûê</div><p className="text-text-main text-sm font-medium leading-relaxed">{journalAiResponse}</p></div>}
                                    </div>
                                    <div className="bg-gray-50 border border-gray-100 p-3 rounded-2xl flex flex-col gap-3">
                                        <div className="flex items-center gap-2 text-brand-600 font-bold px-1 text-xs"><IconByName name="Bot" className="w-4 h-4"/> AI ÊëòË¶Å</div>
                                        <button onClick={handleJournalAI} className="w-full py-2 bg-white border border-gray-200 text-brand-600 text-xs font-bold rounded-xl hover:bg-brand-50 transition-all flex items-center justify-center gap-1 shadow-sm"><IconByName name="Sparkles" className="w-3 h-3"/> ÁîüÊàêÂàÜÊûê</button>
                                        <button onClick={() => { saveDataToLocal({ ...data, journals: { ...data.journals, [getLocalDateStr(journalSelectedDate)]: { content: journalText, tasks: dayTasks } } }); showToast("Â∑≤ÂÑ≤Â≠ò ‚ú®"); }} className="w-full py-3 bg-brand-500 text-white rounded-xl font-bold shadow-sm hover:bg-brand-600 transition-all active:scale-95 flex items-center justify-center gap-2 text-sm"><IconByName name="Save" className="w-4 h-4"/> ÂÑ≤Â≠òÊó•Ë®ò</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'analysis' && (
                            <div className="animate-slide-up space-y-6 h-full flex flex-col pb-20">
                                <div className="bg-white rounded-2xl shadow-sm p-4 flex items-center justify-between border border-gray-100">
                                    <div className="flex bg-gray-50 p-1 rounded-xl">
                                        <button onClick={() => setAnalysisViewMode('day')} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${analysisViewMode==='day'?'bg-white shadow-sm text-brand-600':'text-text-light'}`}>üìÖ ÂñÆÊó•</button>
                                        <button onClick={() => setAnalysisViewMode('total')} className={`px-4 py-2 rounded-lg text-xs font-bold transition-all ${analysisViewMode==='total'?'bg-white shadow-sm text-brand-600':'text-text-light'}`}>‚ôæÔ∏è ÂÖ®ÊôÇÊÆµ</button>
                                    </div>
                                    {analysisViewMode === 'day' && <div className="flex items-center gap-3 bg-gray-50 px-3 py-1.5 rounded-xl relative text-text-main"><button onClick={() => { const prev = new Date(analysisDate); prev.setDate(prev.getDate()-1); setAnalysisDate(prev); }}><IconByName name="ChevronLeft" className="w-4 h-4"/></button><div className="font-bold text-sm min-w-[90px] text-center relative">{getLocalDateStr(analysisDate)}<input type="date" className="absolute inset-0 opacity-0 cursor-pointer" onChange={(e) => setAnalysisDate(new Date(e.target.value))} /></div><button onClick={() => { const next = new Date(analysisDate); next.setDate(next.getDate()+1); setAnalysisDate(next); }}><IconByName name="ChevronRight" className="w-4 h-4"/></button></div>}
                                </div>
                                <div className="flex flex-col lg:flex-row gap-6">
                                    <div className="w-full lg:w-[40%] bg-white p-6 rounded-2xl shadow-sm flex flex-col border border-gray-100">
                                        <h3 className="font-bold text-text-main mb-4 text-lg flex items-center gap-2"><IconByName name="BarChart2" className="w-5 h-5 text-rest-500"/> ÂÉπÂÄºÂàÜ‰Ωà</h3>
                                        <div className="flex-1 flex flex-col items-center justify-center"><DonutChart data={chartData} /><div className="w-full mt-6 space-y-3">{chartData.map((d, i) => (<div key={i} className="flex items-center justify-between p-2 rounded-xl bg-gray-50"><div className="flex items-center gap-2"><div className="w-2 h-2 rounded-full shadow-sm" style={{backgroundColor: d.color}}></div><span className="font-bold text-xs text-text-main">{d.name}</span></div><span className="font-mono font-bold text-xs text-text-main">{formatDurationSimple(d.value)}</span></div>))}</div></div>
                                    </div>
                                    <div className="w-full lg:w-[60%] flex flex-col gap-4">
                                        <div className="bg-brand-50 border border-brand-100 p-6 rounded-2xl shadow-sm flex-1"><h3 className="font-bold text-brand-900 mb-2 text-lg flex items-center gap-2"><IconByName name="Zap" className="w-5 h-5"/> ÊàêÈï∑ËÉΩÈáè</h3><p className="text-brand-900 text-sm leading-relaxed font-medium">{dashboardStats.totalDuration > 0 ? (<>‰Ω†Ëä±‰∫Ü <span className="text-2xl font-bold">{dashboardStats.growthPercent}%</span> ÁöÑÊôÇÈñìÂú®ËÆäÂº∑ÔºÅ<br/>{dashboardStats.growthPercent > 50 ? "ÂìáÔºÅÈÄôÊÆµÊôÇÈñì‰Ω†Á∞°Áõ¥ÊòØÂ≠∏ÁøíÂ∞èÊÄ™Áç∏ ü¶ñ" : "‰∏ÄÊ≠•‰∏ÄÊ≠•‰æÜÔºåÁ¥ØÁ©çÂ∞±ÊòØÂäõÈáè üå±"}</>) : ("ÈÇÑÊ≤íÊúâË∂≥Â§†Êï∏ÊìöÔºåÈñãÂßãÁ¥ÄÈåÑÂêßÔºÅ‚ú®")}</p></div>
                                        <div className="bg-blue-50 border border-blue-100 p-6 rounded-2xl shadow-sm flex-1"><h3 className="font-bold text-rest-500 mb-2 text-lg flex items-center gap-2"><IconByName name="Coffee" className="w-5 h-5"/> Ê∫´È¶®ÊèêÈÜí</h3><p className="text-text-main text-sm leading-relaxed font-medium">{dashboardStats.totalDuration > 0 ? (dashboardStats.totalDuration > 8 * 3600 ? "‰ªäÂ§©Ë®òÈåÑË∂ÖÈÅé 8 Â∞èÊôÇ‰∫ÜÔºå‰ºëÊÅØ‰∏Ä‰∏ãÂêß üåô" : "Ë®òÂæóÁµ¶Ëá™Â∑±‰∏ÄÈªû„ÄåÁÑ°ÊâÄ‰∫ã‰∫ã„ÄçÁöÑÊôÇÈñì ‚ú®") : ("‰ºëÊÅØ‰πüÊòØ‰∏ÄÁ®ÆÊäïË≥á„ÄÇÊ∫ñÂÇôÂ•ΩÈñãÂßã‰∫ÜÂóéÔºüüöÄ")}</p></div>
                                    </div>
                                </div>
                                <div className="flex-1 bg-white border border-gray-100 rounded-2xl shadow-sm flex flex-col min-h-[400px] overflow-hidden">
                                    <div className="p-4 bg-gray-50 border-b border-gray-100 flex items-center gap-3"><div className="p-1.5 bg-white rounded-lg shadow-sm"><IconByName name="Bot" className="w-5 h-5 text-brand-600"/></div><div><div className="font-bold text-base text-brand-900">AI ÁßÅ‰∫∫ÁÆ°ÂÆ∂</div><div className="text-[10px] font-bold text-brand-400">Âú®Á∑ö‰∏≠</div></div></div>
                                    <div className="flex-1 p-4 overflow-y-auto space-y-4 bg-white">
                                        {managerMessages.map(m => (<div key={m.id} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>{m.role === 'ai' && <div className="w-6 h-6 rounded-full bg-brand-100 flex items-center justify-center mr-2 flex-shrink-0"><IconByName name="Bot" className="w-3 h-3 text-brand-600"/></div>}<div className={`max-w-[85%] p-3 rounded-2xl text-sm font-medium leading-relaxed whitespace-pre-wrap ${m.role === 'user' ? 'bg-brand-500 text-white rounded-br-sm' : 'bg-gray-100 text-text-main rounded-bl-sm'}`}>{m.text}</div></div>))}
                                        {isAiTyping && <div className="text-[10px] font-bold text-gray-400 p-2 animate-pulse pl-10">AI Ê≠£Âú®ÊÄùËÄÉ...</div>}
                                        <div ref={chatEndRef}/>
                                    </div>
                                    <div className="p-3 border-t border-gray-100 flex gap-2 bg-gray-50 items-end">
                                        <textarea className="flex-1 p-3 bg-white rounded-2xl outline-none text-sm font-medium border border-transparent focus:border-brand-300 transition-all resize-none shadow-sm" placeholder="ÂëäË®¥Êàë‰Ω†ÁöÑÁãÄÊÖã..." rows="1" value={managerInput} onChange={e=>setManagerInput(e.target.value)} onKeyDown={e => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleManagerChat(); }}} />
                                        <button onClick={handleManagerChat} className="p-3 bg-brand-500 text-white rounded-2xl hover:bg-brand-600 transition-colors shadow-sm h-11 w-11 flex items-center justify-center flex-shrink-0"><IconByName name="Send" className="w-4 h-4"/></button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'muse' && (
                            <div className="animate-slide-up space-y-4 h-full flex flex-col pb-20">
                                <div className="bg-white rounded-2xl shadow-sm p-5 border border-gray-100 flex-1 flex flex-col min-h-[500px]">
                                    <h2 className="text-xl font-bold text-text-main mb-4 flex items-center gap-2"><IconByName name="Lightbulb" className="w-6 h-6 text-accent-yellow"/> ÈùàÊÑüÁ¢éÁâá</h2>
                                    <div className="flex gap-3 mb-6">
                                        <input className="flex-1 px-4 py-3 bg-gray-50 rounded-xl outline-none text-sm font-medium focus:ring-1 focus:ring-brand-500 transition-all text-text-main placeholder-gray-400" placeholder="ÊçïÊçâ‰∏ÄÂÄãÊÉ≥Ê≥ï..." value={newInspiration} onChange={e=>setNewInspiration(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addInspiration()} />
                                        <button onClick={addInspiration} className="p-3 bg-brand-500 text-white rounded-xl hover:bg-brand-600 transition-colors shadow-sm active:scale-95"><IconByName name="Plus" className="w-5 h-5"/></button>
                                    </div>
                                    <div className="grid grid-cols-1 gap-3 overflow-y-auto content-start">
                                        {(data.inspirations || []).map((item) => (
                                            <div key={item.id} className="bg-gray-50/80 p-4 rounded-xl border border-transparent hover:border-gray-200 group relative transition-all">
                                                <div className="text-[10px] text-gray-400 font-bold mb-1">{item.date}</div>
                                                <div className="text-sm font-medium text-text-main leading-relaxed whitespace-pre-wrap pr-6">{item.text}</div>
                                                <button onClick={()=>{const newInspirations=data.inspirations.filter(i=>i.id!==item.id); saveDataToLocal({...data, inspirations: newInspirations});}} className="absolute top-3 right-3 text-gray-300 hover:text-waste-500 transition-colors"><IconByName name="Trash2" className="w-4 h-4"/></button>
                                            </div>
                                        ))}
                                        {(data.inspirations || []).length === 0 && <div className="flex-1 flex flex-col items-center justify-center text-center py-10 opacity-50"><IconByName name="Sparkles" className="w-10 h-10 text-gray-300 mb-2"/><div className="text-xs text-gray-400 font-bold">ÈÇÑÊ≤íÊúâÈùàÊÑüÂñîÔºåÂø´Ë®ò‰∏ã‰æÜÂêß ‚ú®</div></div>}
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="bg-white rounded-2xl shadow-sm p-6 space-y-6 animate-slide-up border border-gray-100 pb-20">
                                <h2 className="font-bold text-xl flex items-center gap-2 text-text-main"><IconByName name="Settings" className="w-6 h-6"/> Ë®≠ÂÆö</h2>
                                <div><label className="block font-bold text-sm text-text-main mb-3">ÊôÇÂÖâÊøæÈè° (Theme)</label><div className="flex gap-3"><button onClick={()=>setTheme('default')} className={`flex-1 p-3 rounded-xl font-bold border-2 transition-all text-sm ${theme==='default'?'border-brand-500 bg-brand-50 text-brand-600':'border-gray-100 bg-white text-text-light'}`}>Êô®Êõ¶</button><button onClick={()=>setTheme('dark')} className={`flex-1 p-3 rounded-xl font-bold border-2 transition-all text-sm ${theme==='dark'?'border-gray-600 bg-gray-800 text-white':'border-gray-100 bg-white text-text-light'}`}>Ê∑±Â§ú</button><button onClick={()=>setTheme('paper')} className={`flex-1 p-3 rounded-xl font-bold border-2 transition-all text-sm ${theme==='paper'?'border-orange-200 bg-orange-50 text-orange-800':'border-gray-100 bg-white text-text-light'}`}>ÊâãÂØ´</button></div></div>
                                <div><label className="block font-bold text-sm text-text-main mb-3">GAS ÈÄ£Áµê (Ë≥áÊñôÂêåÊ≠•)</label><div className="flex gap-2"><input type="text" className="flex-1 p-3 border border-gray-200 rounded-xl outline-none focus:border-brand-500 font-medium text-sm text-text-main transition-colors bg-gray-50" value={localScriptUrl} onChange={e => setLocalScriptUrl(e.target.value)} onBlur={() => localStorage.setItem(GAS_URL_KEY, localScriptUrl)} placeholder="Ë≤º‰∏ä Google Script Á∂≤ÂùÄ..." /><button onClick={syncFromGoogleSheet} className="px-4 py-2 bg-gray-800 text-white rounded-xl font-bold flex items-center gap-2 hover:bg-black transition-colors shadow-sm text-xs"><IconByName name="RefreshCcw" className={`w-4 h-4 ${isSyncing?'animate-spin':''}`}/> ÂåØÂÖ•</button></div></div>
                                <div><label className="block font-bold text-sm text-text-main mb-3">Gemini API Key (Â§ßËÖ¶)</label><div className="flex gap-2"><input type="password" className="flex-1 p-3 border border-gray-200 rounded-xl outline-none focus:border-brand-500 font-medium text-sm text-text-main transition-colors bg-gray-50" value={geminiKey} onChange={e => setGeminiKey(e.target.value)} placeholder="Ë≤º‰∏ä‰Ω†ÁöÑ API Key..." /><button onClick={saveKey} className="px-4 py-2 bg-brand-500 text-white rounded-xl font-bold hover:bg-brand-600 transition-colors shadow-sm text-xs">ÂÑ≤Â≠ò</button><button onClick={detectModels} className="px-4 py-2 bg-white border border-brand-200 text-brand-600 rounded-xl font-bold hover:bg-brand-50 transition-colors text-xs">ÂÅµÊ∏¨</button></div>{availableModels.length > 0 && (<div className="mt-3"><label className="block font-bold text-xs text-gray-400 mb-2">ÈÅ∏ÊìáÊ®°Âûã</label><select value={selectedModel} onChange={(e) => { setSelectedModel(e.target.value); localStorage.setItem(GEMINI_MODEL_KEY, e.target.value); }} className="w-full p-3 rounded-xl border border-gray-200 bg-white text-sm font-medium outline-none focus:border-brand-500">{availableModels.map(m => <option key={m} value={m}>{m}</option>)}</select></div>)}<p className="text-gray-400 text-[10px] font-bold mt-2 pl-1">üîí Key ÂÉÖÂÑ≤Â≠òÊñºÁÄèË¶ΩÂô®</p></div>
                            </div>
                        )}
                    </main>

                    <nav className="md:hidden fixed bottom-0 w-full bg-white/90 backdrop-blur-md border-t border-gray-100 flex justify-around items-center p-2 pb-safe z-40 shadow-[0_-4px_20px_-5px_rgba(0,0,0,0.05)] rounded-t-2xl transition-colors duration-300">
                        <NavButton active={view === 'tracker'} onClick={() => setView('tracker')} icon="Clock" label="ÊôÇÂÖâ" mobile />
                        <NavButton active={view === 'journal'} onClick={() => setView('journal')} icon="Book" label="Êó•Ë®ò" mobile />
                        <NavButton active={view === 'analysis'} onClick={() => setView('analysis')} icon="BarChart2" label="Ê¥ûÂØü" mobile />
                        <NavButton active={view === 'muse'} onClick={() => setView('muse')} icon="Lightbulb" label="ÈùàÊÑü" mobile />
                        <NavButton active={view === 'settings'} onClick={() => setView('settings')} icon="Settings" label="Ë®≠ÂÆö" mobile />
                    </nav>

                    <Modal isOpen={showReviewModal} onClose={() => setShowReviewModal(false)} title="Ë®òÈåÑÈÄôÊÆµÊôÇÂÖâ">
                        <div className="space-y-5">
                            <div className="text-center bg-brand-50 p-5 rounded-2xl border border-brand-100 relative overflow-hidden">
                                <div className="text-4xl font-mono font-bold text-brand-600 relative z-10">
                                    {manualMinutes ? `${manualMinutes.padStart(2, '0')}:00` : (reviewSessionCache ? formatTime(Math.floor((Date.now() - reviewSessionCache.startTime) / 1000)) : '00:00')}
                                </div>
                                <IconByName name="Clock" className="absolute -bottom-3 -right-3 w-20 h-20 text-brand-200 opacity-50 rotate-12"/>
                            </div>

                            {reviewSessionCache && ['sports', 'others'].includes(reviewSessionCache.category) && (
                                <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 animate-fade-in">
                                    <label className="block text-xs font-bold text-gray-500 mb-2 text-center flex items-center justify-center gap-1"><IconByName name={reviewSessionCache.category === 'sports' ? 'Dumbbell' : 'Clock'} className="w-3 h-3"/> {reviewSessionCache.category === 'sports' ? ' ÂØ¶ÈöõÈÅãÂãïÂ§ö‰πÖÔºü' : ' ÈÄô‰ª∂‰∫ãËä±‰∫ÜÂ§ö‰πÖÔºü'}</label>
                                    <div className="flex items-center justify-center gap-2">
                                        <input type="number" value={manualMinutes} onChange={(e) => setManualMinutes(e.target.value)} className="w-24 p-2 text-center text-xl font-bold rounded-lg border border-gray-200 outline-none focus:border-brand-500 text-brand-600 bg-white shadow-sm" placeholder={reviewSessionCache.category === 'sports' ? "30" : "10"} autoFocus />
                                        <span className="font-bold text-gray-400 text-sm">ÂàÜÈêò</span>
                                    </div>
                                </div>
                            )}

                            <div>
                                <label className="block font-bold text-sm text-text-main mb-3 pl-1">ÈÄôÊÆµÊôÇÈñìÊÑüË¶∫Â¶Ç‰ΩïÔºü</label>
                                <div className="grid grid-cols-1 gap-2">
                                    {VALUE_TYPES.map(type => (
                                        <button key={type.id} onClick={() => setReviewType(type.id)} className={`p-3 rounded-xl border-2 font-bold flex items-center justify-between transition-all ${reviewType === type.id ? (type.id==='growth'?'border-brand-500 bg-brand-50':type.id==='rest'?'border-rest-500 bg-blue-50':'border-waste-500 bg-red-50') : 'border-gray-100 bg-white hover:border-gray-200'}`}>
                                            <span className={`text-sm ${reviewType===type.id ? 'text-text-main' : 'text-text-light'}`}>{type.label}</span>
                                            {reviewType === type.id && <IconByName name="CheckCircle" className={`w-5 h-5 ${type.id==='growth'?'text-brand-500':type.id==='rest'?'text-rest-500':'text-waste-500'}`} />}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {reviewSessionCache && CATEGORY_FIELDS[reviewSessionCache.category] && (
                                <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 space-y-3">
                                    <h4 className="font-bold text-xs text-gray-400 flex items-center gap-1"><IconByName name="Settings" className="w-3 h-3"/> Ë©≥Á¥∞Á¥ÄÈåÑ</h4>
                                    {CATEGORY_FIELDS[reviewSessionCache.category].map(field => (
                                        <div key={field.key}>
                                            <label className="block text-xs font-bold text-gray-500 mb-1 pl-1">{field.label}</label>
                                            {field.type === 'select' ? (
                                                <select className="w-full p-2 rounded-lg border border-gray-200 bg-white text-sm font-medium outline-none focus:border-brand-500 transition-colors" onChange={e => setReviewMetaData({...reviewMetaData, [field.key]: e.target.value})}>
                                                    <option value="">ÈÅ∏Êìá...</option>
                                                    {field.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                </select>
                                            ) : (
                                                <input type="text" className="w-full p-2 rounded-lg border border-gray-200 bg-white text-sm font-medium outline-none focus:border-brand-500 transition-colors" placeholder={field.placeholder} onChange={e => setReviewMetaData({...reviewMetaData, [field.key]: e.target.value})} />
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}

                            <div>
                                <label className="block font-bold text-sm text-text-main mb-3 pl-1">Áµ¶Ëá™Â∑±ÂπæÈ°ÜÊòüÔºü</label>
                                <div className="flex justify-center gap-1 bg-white p-3 rounded-xl border border-gray-100 shadow-sm">
                                    {[1, 2, 3, 4, 5].map(star => (
                                        <button key={star} onClick={() => setReviewRating(star)} className="hover:scale-110 transition-transform active:scale-90 p-1">
                                            <IconByName name="Star" className={`w-7 h-7 ${star <= reviewRating ? "text-accent-yellow fill-accent-yellow" : "text-gray-200"}`} />
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <button onClick={submitReview} className="w-full py-3 bg-brand-500 text-white rounded-xl font-bold text-lg shadow-md hover:bg-brand-600 hover:shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2">
                                <IconByName name="Save" className="w-5 h-5"/> Á¢∫Ë™ç‰∏¶ÂÑ≤Â≠ò ‚ú®
                            </button>
                        </div>
                    </Modal>
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
